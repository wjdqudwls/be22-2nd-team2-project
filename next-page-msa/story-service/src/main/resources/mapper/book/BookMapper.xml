<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.team2.nextpage.query.book.mapper.BookMapper">

    <!-- 소설 목록 조회 (필터링/검색/페이징) -->
    <select id="findBooks" resultType="BookDto">
        SELECT
            b.book_id,
            b.writer_id,
            b.category_id,
            b.title,
            b.status,
            b.current_sequence,
            b.max_sequence,
            b.created_at
        FROM books b
        <where>
            <if test="request.status != null and request.status != ''">
                AND b.status = #{request.status}
            </if>
            <if test="request.categoryId != null and request.categoryId != ''">
                AND b.category_id = #{request.categoryId}
            </if>
            <if test="request.keyword != null and request.keyword != ''">
                AND b.title LIKE CONCAT('%', #{request.keyword}, '%')
            </if>
            <if test="request.writerId != null">
                AND b.writer_id = #{request.writerId}
            </if>
        </where>
        <choose>
            <when test="request.sortBy == 'title'">
                ORDER BY b.title
            </when>
            <otherwise>
                ORDER BY b.created_at
            </otherwise>
        </choose>
        <choose>
            <when test="request.sortOrder == 'ASC'">
                ASC
            </when>
            <otherwise>
                DESC
            </otherwise>
        </choose>
        LIMIT #{request.size} OFFSET #{request.offset}
    </select>

    <!-- 소설 전체 개수 조회 (페이징용) -->
    <select id="countBooks" resultType="long">
        SELECT COUNT(*)
        FROM books b
        <where>
            <if test="request.status != null and request.status != ''">
                AND b.status = #{request.status}
            </if>
            <if test="request.categoryId != null and request.categoryId != ''">
                AND b.category_id = #{request.categoryId}
            </if>
            <if test="request.keyword != null and request.keyword != ''">
                AND b.title LIKE CONCAT('%', #{request.keyword}, '%')
            </if>
            <if test="request.writerId != null">
                AND b.writer_id = #{request.writerId}
            </if>
        </where>
    </select>

    <!-- 소설 상세 조회 (기본) -->
    <select id="findBookDetail" parameterType="long" resultType="BookDto">
        SELECT
            b.book_id,
            b.writer_id,
            b.category_id,
            b.title,
            b.status,
            b.current_sequence,
            b.max_sequence,
            b.created_at
        FROM books b
        WHERE b.book_id = #{bookId}
    </select>

    <!-- 소설 상세 조회 (뷰어용 - 작성자 닉네임 포함) -->
    <select id="findBookForViewer" resultType="BookDetailDto">
        SELECT
            b.book_id,
            b.writer_id,
            u.user_nicknm AS writerNicknm,
            b.category_id,
            b.title,
            b.status,
            b.current_sequence,
            b.max_sequence,
            b.created_at,
            b.last_writer_user_id AS lastWriterUserId,
            (SELECT vote_type FROM book_votes WHERE book_id = b.book_id AND voter_id = #{userId}) AS myVote
        FROM books b
        LEFT JOIN users u ON b.writer_id = u.user_id
        WHERE b.book_id = #{bookId}
    </select>

    <!-- 소설의 문장 목록 조회 -->
    <select id="findSentencesByBookId" resultType="SentenceDto">
        SELECT
            s.sentence_id,
            s.sequence_no,
            s.content,
            s.writer_id,
            u.user_nicknm AS writerNicknm,
            s.created_at,
            (SELECT COUNT(*) FROM sentence_votes sv WHERE sv.sentence_id = s.sentence_id AND sv.vote_type = 'LIKE') AS likeCount,
            (SELECT COUNT(*) FROM sentence_votes sv WHERE sv.sentence_id = s.sentence_id AND sv.vote_type = 'DISLIKE') AS dislikeCount,
            (SELECT vote_type FROM sentence_votes WHERE sentence_id = s.sentence_id AND voter_id = #{userId}) AS myVote
        FROM sentences s
        LEFT JOIN users u ON s.writer_id = u.user_id
        WHERE s.book_id = #{bookId}
        ORDER BY s.sequence_no ASC
    </select>

    <!-- 소설의 좋아요 수 조회 -->
    <select id="countLikes" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM book_votes
        WHERE book_id = #{bookId}
          AND vote_type = 'LIKE'
    </select>

    <!-- 소설의 싫어요 수 조회 -->
    <select id="countDislikes" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM book_votes
        WHERE book_id = #{bookId}
          AND vote_type = 'DISLIKE'
    </select>

    <!-- 기존 메서드 (하위 호환용) -->
    <select id="findAllBooks" resultType="BookDto">
        SELECT
            b.book_id,
            b.writer_id,
            b.category_id,
            b.title,
            b.status,
            b.current_sequence,
            b.max_sequence,
            b.created_at
        FROM books b
        ORDER BY b.created_at DESC
    </select>


    <!-- 특정 사용자가 쓴 문장 목록 조회 -->
    <select id="findSentencesByWriterId" resultType="SentenceDto">
        SELECT
            s.sentence_id,
            s.sequence_no,
            s.content,
            s.writer_id,
            u.user_nicknm AS writerNicknm,
            s.created_at,
            s.book_id AS bookId,
            (SELECT title FROM books b WHERE b.book_id = s.book_id) AS bookTitle,
            (SELECT COUNT(*) FROM sentence_votes sv WHERE sv.sentence_id = s.sentence_id AND sv.vote_type = 'LIKE') AS likeCount,
            (SELECT COUNT(*) FROM sentence_votes sv WHERE sv.sentence_id = s.sentence_id AND sv.vote_type = 'DISLIKE') AS dislikeCount
        FROM sentences s
        LEFT JOIN users u ON s.writer_id = u.user_id
        WHERE s.writer_id = #{writerId}
        ORDER BY s.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 특정 사용자가 쓴 문장 개수 조회 -->
    <select id="countSentencesByWriterId" resultType="long">
        SELECT COUNT(*)
        FROM sentences
        WHERE writer_id = #{writerId}
    </select>
</mapper>
